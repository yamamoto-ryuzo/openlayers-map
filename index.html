<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Cesium 3D GeoJSON Viewer - GitHub Pagesç‰ˆ</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    body { margin: 0; padding: 10px; font-family: Arial, sans-serif; }
    h1 { margin: 0 0 10px 0; }
    #cesiumContainer { width: 100%; height: 600px; display: block; border: 1px solid #ccc; }
    #fileInput { margin: 10px 0; }
    #status { margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 4px; }
    .retry-button { 
      margin: 10px 0; 
      padding: 10px 20px; 
      background: #007bff; 
      color: white; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
    }
    .retry-button:hover { background: #0056b3; }
  </style>
</head>
<body>
  <h1>ğŸŒ Cesium 3D GeoJSON Viewer (GitHub Pagesç‰ˆ)</h1>
  <div style="margin: 10px 0; padding: 10px; background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 4px;">
    <strong>ğŸ“ å‹•ä½œç¢ºèªæ¸ˆã¿:</strong> VS Codeãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®å‹•ä½œã‚’åŸºã«GitHub Pagesç”¨ã«æœ€é©åŒ–<br>
    <strong>ğŸ”„ è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰:</strong> 3D â†’ Columbus View (2.5D) â†’ 2D ã®3ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆå¯¾å¿œ
  </div>
  <div style="margin: 10px 0; padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px;">
    <strong>âš ï¸ é‡è¦ãªæ³¨æ„äº‹é …:</strong><br>
    â€¢ èƒŒæ™¯åœ°å›³ã®èª­ã¿è¾¼ã¿ã«ã¯<strong>5-10ç§’é–“ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ</strong>ãŒå¿…è¦ã§ã™<br>
    â€¢ åˆå›è¡¨ç¤ºæ™‚ã‚„é…ã„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§ã¯èƒŒæ™¯ãŒé…ã‚Œã¦è¡¨ç¤ºã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™<br>
    â€¢ èƒŒæ™¯ãŒè¡¨ç¤ºã•ã‚Œãªã„å ´åˆã¯<strong>20-30ç§’</strong>ãŠå¾…ã¡ãã ã•ã„<br>
    â€¢ <strong>è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ™‚</strong>ã«ã‚‚å†åº¦ã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿ãŒç™ºç”Ÿã—ã¾ã™<br>
    â€¢ GitHub Pagesã®å¤–éƒ¨ã‚¿ã‚¤ãƒ«ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚»ã‚¹ã«ã¯æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™<br>
    â€¢ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒé…ã„å ´åˆã¯ã€ã•ã‚‰ã«æ™‚é–“ãŒã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™
  </div>
  <div id="status">åˆæœŸåŒ–ä¸­...</div>
  <button class="retry-button" onclick="retryMapLoad()" style="display: none;" id="retryButton">
    ğŸ”„ èƒŒæ™¯åœ°å›³ã®å†èª­ã¿è¾¼ã¿
  </button>
  <div style="margin: 10px 0;">
    <button class="retry-button" onclick="toggle3D2D()" id="toggleButton" style="display: none;">
      ğŸŒ Columbus Viewã«åˆ‡ã‚Šæ›¿ãˆ
    </button>
  </div>
  <input type="file" id="fileInput" accept=".geojson,.json" />
  <div id="cesiumContainer"></div>
  
  <script>
    const statusDiv = document.getElementById('status');
    let viewer = null;
    
    function updateStatus(message) {
      statusDiv.textContent = message;
      console.log(message);
    }

    // æ®µéšçš„åˆæœŸåŒ–ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ç‰ˆï¼‰
    async function initializeCesium() {
      updateStatus('Cesiumãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã‚’åˆæœŸåŒ–ä¸­...');
      
      try {
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è¿½åŠ ã—ãŸCesiumãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼è¨­å®š
        viewer = new Cesium.Viewer('cesiumContainer', {
          imageryProvider: false,
          baseLayerPicker: false,
          vrButton: false,
          geocoder: false,
          homeButton: true,
          sceneModePicker: true,  // 3D/2Dåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
          navigationHelpButton: false,
          animation: false,
          timeline: false,
          fullscreenButton: true,
          shouldAnimate: true,
          requestRenderMode: false, // ç¶™ç¶šçš„ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’æœ‰åŠ¹åŒ–
          maximumRenderTimeChange: Infinity
        });

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¿½åŠ 
        viewer.cesiumWidget.creditContainer.style.display = "none";
        
        // Cesiumã®å†…éƒ¨ã‚¨ãƒ©ãƒ¼ã‚’æ•æ‰
        viewer.scene.renderError.addEventListener(function(scene, error) {
          console.log('Cesiumæç”»ã‚¨ãƒ©ãƒ¼:', error);
        });

        updateStatus('ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ä½œæˆå®Œäº†ã€‚èƒŒæ™¯åœ°å›³ã‚’è¨­å®šä¸­...');

        // èƒŒæ™¯ã‚’ä¸€æ™‚çš„ã«å˜è‰²ã«è¨­å®š
        viewer.scene.globe.show = false;
        viewer.scene.backgroundColor = Cesium.Color.LIGHTSTEELBLUE;

        // Promise ãƒã‚§ãƒ¼ãƒ³ã®ä»£ã‚ã‚Šã«async/awaitä½¿ç”¨ã§ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ”¹å–„
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        updateStatus('Step 1: åŸºæœ¬åœ°çƒã‚’è¡¨ç¤ºä¸­...');
        viewer.scene.globe.show = true;
        viewer.scene.backgroundColor = Cesium.Color.LIGHTSTEELBLUE;
        
        await new Promise(resolve => setTimeout(resolve, 3000));
        
        try {
          updateStatus('Step 2: OpenStreetMapã‚’èª­ã¿è¾¼ã¿ä¸­... (æœ€å¤§30ç§’ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™)');
          
          const osmProvider = new Cesium.UrlTemplateImageryProvider({
            url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
            subdomains: ['a', 'b', 'c'],
            maximumLevel: 19,
            minimumLevel: 0,
            credit: 'Map data Â© OpenStreetMap contributors',
            enablePickFeatures: false
          });

          viewer.scene.imageryLayers.addImageryProvider(osmProvider);
          
          updateStatus('Step 3: OpenStreetMapè¿½åŠ å®Œäº†ã€‚ã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿ä¸­...');

          // æ±äº¬ï¼ˆæ±Ÿæ±åŒºï¼‰ã‚’ä¸­å¿ƒã«è¨­å®š
          viewer.camera.setView({
            destination: Cesium.Cartesian3.fromDegrees(139.831, 35.681, 50000),
            orientation: {
              heading: 0.0,
              pitch: -Math.PI / 4,
              roll: 0.0
            }
          });

          // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
          setupEventListeners();
          
          // ã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿ç›£è¦–ã‚’è¿½åŠ 
          monitorTileLoading();
          
          // 3D/2Dåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
          document.getElementById('toggleButton').style.display = 'inline-block';
          
          // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆGeoJSONã‚’èª­ã¿è¾¼ã¿ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
          await new Promise(resolve => setTimeout(resolve, 2000));
          await loadDefaultGeoJSONSafe();

        } catch (osmError) {
          console.error('OpenStreetMapèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', osmError);
          updateStatus('OpenStreetMapèª­ã¿è¾¼ã¿å¤±æ•—ã€‚åŸºæœ¬è¡¨ç¤ºã§ç¶™ç¶šã—ã¾ã™ã€‚');
          
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: åŸºæœ¬è¡¨ç¤ºã§ã‚‚æ“ä½œå¯èƒ½ã«ã™ã‚‹
          setupEventListeners();
          await loadDefaultGeoJSONSafe();
        }

      } catch (error) {
        console.error('CesiumåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        updateStatus('Cesiumã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        document.getElementById('cesiumContainer').innerHTML = 
          '<div style="padding: 20px; color: red; text-align: center;">3Dåœ°å›³ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ<br>' + 
          'ãƒ–ãƒ©ã‚¦ã‚¶ã‚’æ›´æ–°ã™ã‚‹ã‹ã€index2d.htmlã‚’è©¦ã—ã¦ãã ã•ã„</div>';
      }
    }

    // ã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿ç›£è¦–
    function monitorTileLoading() {
      if (!viewer || !viewer.scene || !viewer.scene.globe) return;

      let tileLoadCount = 0;
      const startTime = Date.now();

      const checkTiles = setInterval(() => {
        const tilesLoaded = viewer.scene.globe.tilesLoaded;
        if (tilesLoaded) {
          tileLoadCount++;
          const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
          updateStatus(`âœ… OpenStreetMapã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†ï¼ (${elapsed}ç§’)`);
          clearInterval(checkTiles);
        }
      }, 500);

      // 30ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè­¦å‘Šã¨ãƒªãƒˆãƒ©ã‚¤ãƒœã‚¿ãƒ³è¡¨ç¤º
      setTimeout(() => {
        clearInterval(checkTiles);
        if (tileLoadCount === 0) {
          updateStatus('âš ï¸ ã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿ãŒé…ã‚Œã¦ã„ã¾ã™ã€‚ä¸‹ã®ãƒœã‚¿ãƒ³ã§å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
          document.getElementById('retryButton').style.display = 'block';
        }
      }, 30000);
    }

    // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆç”¨ã®ã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿ç›£è¦–
    function monitorTileLoadingForMode(modeName) {
      if (!viewer || !viewer.scene || !viewer.scene.globe) return;

      let tileLoadCount = 0;
      const startTime = Date.now();
      let isCompleted = false;

      const checkTiles = setInterval(() => {
        if (isCompleted) {
          clearInterval(checkTiles);
          return;
        }

        const tilesLoaded = viewer.scene.globe.tilesLoaded;
        if (tilesLoaded) {
          tileLoadCount++;
          const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
          updateStatus(`âœ… ${modeName}ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤ºå®Œäº†ï¼ (${elapsed}ç§’)`);
          isCompleted = true;
          clearInterval(checkTiles);
        }
      }, 500);

      // 15ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆã¯çŸ­ã‚ã«ï¼‰
      setTimeout(() => {
        if (!isCompleted) {
          clearInterval(checkTiles);
          if (tileLoadCount === 0) {
            updateStatus(`âš ï¸ ${modeName}ã®ã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿ãŒé…ã‚Œã¦ã„ã¾ã™...`);
          }
        }
      }, 15000);
    }

    // èƒŒæ™¯åœ°å›³ã®å†èª­ã¿è¾¼ã¿æ©Ÿèƒ½
    function retryMapLoad() {
      updateStatus('èƒŒæ™¯åœ°å›³ã‚’å†èª­ã¿è¾¼ã¿ä¸­...');
      document.getElementById('retryButton').style.display = 'none';
      
      if (viewer && viewer.scene && viewer.scene.imageryLayers) {
        viewer.scene.imageryLayers.removeAll();
        
        setTimeout(() => {
          try {
            const osmProvider = new Cesium.UrlTemplateImageryProvider({
              url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
              subdomains: ['a', 'b', 'c'],
              maximumLevel: 19,
              minimumLevel: 0,
              credit: 'Map data Â© OpenStreetMap contributors',
              enablePickFeatures: false
            });

            viewer.scene.imageryLayers.addImageryProvider(osmProvider);
            updateStatus('èƒŒæ™¯åœ°å›³ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã—ãŸã€‚ã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿ä¸­...');
            monitorTileLoading();
            
          } catch (error) {
            updateStatus('å†èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            document.getElementById('retryButton').style.display = 'block';
          }
        }, 1000);
      }
    }

    // 3D/2Dè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ï¼ˆ3ã¤ã®ãƒ¢ãƒ¼ãƒ‰ã‚’ã‚µã‚¤ã‚¯ãƒ«ï¼‰- ãƒ‡ãƒãƒƒã‚°å¼·åŒ–ç‰ˆ
    function toggle3D2D() {
      if (!viewer) {
        console.error('ViewerãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }
      
      const scene = viewer.scene;
      const toggleButton = document.getElementById('toggleButton');
      
      console.log('ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰:', scene.mode);
      console.log('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹æ•°:', viewer.dataSources.length);
      
      // GEOJSONãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ä¿å­˜ï¼ˆãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ™‚ã«ä¿æŒã™ã‚‹ãŸã‚ï¼‰
      const dataSources = [];
      for (let i = 0; i < viewer.dataSources.length; i++) {
        const dataSource = viewer.dataSources.get(i);
        dataSources.push(dataSource);
      }
      console.log('ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹æ•°:', dataSources.length);
      
      if (scene.mode === Cesium.SceneMode.SCENE3D) {
        // 3D â†’ Columbus View (2.5D)
        updateStatus('Columbus View (2.5D) ã«åˆ‡ã‚Šæ›¿ãˆä¸­...');
        scene.mode = Cesium.SceneMode.COLUMBUS_VIEW;
        toggleButton.textContent = 'ğŸ—ºï¸ 2Dè¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆ';
        
        // Columbus Viewç”¨ã®ã‚«ãƒ¡ãƒ©è¨­å®šã¨ã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿ç›£è¦–
        setTimeout(async () => {
          console.log('Columbus Viewåˆ‡ã‚Šæ›¿ãˆå‡¦ç†é–‹å§‹');
          
          // Columbus Viewåˆ‡ã‚Šæ›¿ãˆç›´å¾Œã«ã‚«ãƒ¡ãƒ©ã‚’æ±Ÿæ±åŒºã«è¨­å®š
          viewer.camera.setView({
            destination: Cesium.Cartesian3.fromDegrees(139.831, 35.681, 100000),
            orientation: {
              heading: 0.0,
              pitch: -Math.PI / 6,  // 30åº¦ä¸‹å‘ã
              roll: 0.0
            }
          });
          console.log('Columbus ViewåˆæœŸã‚«ãƒ¡ãƒ©è¨­å®šå®Œäº†');
          
          // ã‚«ãƒ¡ãƒ©è¨­å®šå¾Œã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
          try {
            console.log('Columbus Viewç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿');
            await reloadDataForColumbusView();
            
            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¾Œã«åº§æ¨™ã‚’ãƒã‚§ãƒƒã‚¯
            setTimeout(() => {
              const wasFixed = forceFixColumbusViewPosition();
              if (wasFixed) {
                updateStatus('âš ï¸ Columbus Viewä½ç½®ã‚’ä¿®æ­£ã—ã¾ã—ãŸ');
              } else {
                updateStatus('âœ… Columbus View (2.5D) åˆ‡ã‚Šæ›¿ãˆå®Œäº†');
              }
            }, 1000);
            
          } catch (error) {
            console.error('Columbus Viewã§ã®GeoJSONèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            updateStatus('âš ï¸ Columbus View (2.5D)ï¼ˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—ï¼‰');
            
            // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚æ±Ÿæ±åŒºã«ã‚«ãƒ¡ãƒ©ã‚’è¨­å®š
            viewer.camera.setView({
              destination: Cesium.Cartesian3.fromDegrees(139.831, 35.681, 100000),
              orientation: {
                heading: 0.0,
                pitch: -Math.PI / 6,
                roll: 0.0
              }
            });
          }
          
          monitorTileLoadingForMode('Columbus View (2.5D)');
        }, 500);
        
      } else if (scene.mode === Cesium.SceneMode.COLUMBUS_VIEW) {
        // Columbus View â†’ 2D
        updateStatus('2Dè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆä¸­...');
        scene.mode = Cesium.SceneMode.SCENE2D;
        toggleButton.textContent = 'ğŸŒ 3Dè¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆ';
        
        // 2Dè¡¨ç¤ºã§ã¯æŠ•å½±æ³•ãŒå¤‰ã‚ã‚‹ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«å†èª­ã¿è¾¼ã¿
        setTimeout(async () => {
          console.log('2Dãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ã‘é–‹å§‹');
          
          // 2Dåˆ‡ã‚Šæ›¿ãˆç›´å¾Œã«ã‚«ãƒ¡ãƒ©ã‚’æ±Ÿæ±åŒºã«å¼·åˆ¶è¨­å®š
          console.log('2Dãƒ¢ãƒ¼ãƒ‰åˆæœŸã‚«ãƒ¡ãƒ©è¨­å®š...');
          viewer.camera.setView({
            destination: Cesium.Cartesian3.fromDegrees(139.831, 35.681, 200000),
            orientation: {
              heading: 0.0,
              pitch: -Math.PI / 2,  // çœŸä¸‹ã‚’å‘ã
              roll: 0.0
            }
          });
          console.log('2Dãƒ¢ãƒ¼ãƒ‰åˆæœŸã‚«ãƒ¡ãƒ©è¨­å®šå®Œäº†');
          
          // æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ä¸€æ—¦å…¨ã¦ã‚¯ãƒªã‚¢
          viewer.dataSources.removeAll();
          
          // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
          await new Promise(resolve => setTimeout(resolve, 500));
          
          // 2Dãƒ¢ãƒ¼ãƒ‰å°‚ç”¨ã®GeoJSONèª­ã¿è¾¼ã¿
          try {
            await reload2DGeoJSON();
            
            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¾Œã«åº§æ¨™ã‚’ãƒã‚§ãƒƒã‚¯
            setTimeout(() => {
              const wasFixed = forceFixScene2DPosition();
              if (wasFixed) {
                updateStatus('âš ï¸ 2Dãƒ¢ãƒ¼ãƒ‰ä½ç½®ã‚’ä¿®æ­£ã—ã¾ã—ãŸ');
              } else {
                updateStatus('âœ… 2Dè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆå®Œäº†');
              }
            }, 1000);
            
          } catch (error) {
            console.error('2Dãƒ¢ãƒ¼ãƒ‰GeoJSONèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            updateStatus('âš ï¸ 2Dè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—ï¼‰');
            
            // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚æ±Ÿæ±åŒºã«ã‚«ãƒ¡ãƒ©ã‚’å¼·åˆ¶è¨­å®š
            viewer.camera.setView({
              destination: Cesium.Cartesian3.fromDegrees(139.831, 35.681, 200000),
              orientation: {
                heading: 0.0,
                pitch: -Math.PI / 2,
                roll: 0.0
              }
            });
          }
          
          // 2Dç”¨ã®ã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿ç›£è¦–
          monitorTileLoadingForMode('2Dè¡¨ç¤º');
        }, 1000);  // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆå¾Œã«å®Ÿè¡Œ
        
      } else {
        // 2D â†’ 3D
        updateStatus('3Dè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆä¸­...');
        scene.mode = Cesium.SceneMode.SCENE3D;
        toggleButton.textContent = 'ğŸŒ Columbus Viewã«åˆ‡ã‚Šæ›¿ãˆ';
        
        // 3Dè¡¨ç¤ºç”¨ã®ã‚«ãƒ¡ãƒ©è¨­å®šã¨ã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿ç›£è¦–
        setTimeout(async () => {
          console.log('3Dãƒ¢ãƒ¼ãƒ‰å¾©å¸°å‡¦ç†é–‹å§‹');
          
          // 3Dãƒ¢ãƒ¼ãƒ‰ç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
          try {
            await loadDefaultGeoJSONSafe();
            updateStatus('âœ… 3Dè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆå®Œäº†');
          } catch (error) {
            console.error('3Dãƒ¢ãƒ¼ãƒ‰GeoJSONèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            updateStatus('âš ï¸ 3Dè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—ï¼‰');
          }
          
          // 3Dãƒ¢ãƒ¼ãƒ‰ç”¨ã®ã‚«ãƒ¡ãƒ©è¨­å®š
          viewer.camera.setView({
            destination: Cesium.Cartesian3.fromDegrees(139.831, 35.681, 50000),
            orientation: {
              heading: 0.0,
              pitch: -Math.PI / 4,  // 45åº¦ä¸‹å‘ã
              roll: 0.0
            }
          });
          
          monitorTileLoadingForMode('3Dè¡¨ç¤º');
        }, 500);
      }
    }

    // GEOJSONãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’å¾©å…ƒã™ã‚‹é–¢æ•°ï¼ˆç°¡ç´ åŒ–ç‰ˆï¼‰
    function restoreDataSources(dataSources) {
      if (!viewer || !dataSources || dataSources.length === 0) return;
      
      // æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ã‚¯ãƒªã‚¢
      viewer.dataSources.removeAll();
      
      // ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’å†è¿½åŠ 
      dataSources.forEach(dataSource => {
        try {
          viewer.dataSources.add(dataSource);
        } catch (error) {
          console.log('ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹å¾©å…ƒã‚¨ãƒ©ãƒ¼:', error);
        }
      });
    }

    // 2Dãƒ¢ãƒ¼ãƒ‰å°‚ç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹å¾©å…ƒé–¢æ•°ï¼ˆç°¡ç•¥åŒ–ç‰ˆï¼‰
    function restoreDataSourcesFor2D(dataSources) {
      if (!viewer || !dataSources || dataSources.length === 0) {
        console.log('2Dãƒ¢ãƒ¼ãƒ‰ï¼šãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãŒãªã„ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆGeoJSONã‚’èª­ã¿è¾¼ã¿ã¾ã™');
        reloadDefaultGeoJSONFor2D();
        return;
      }
      
      console.log('2Dãƒ¢ãƒ¼ãƒ‰ç”¨ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹å¾©å…ƒé–‹å§‹...', dataSources.length, 'å€‹');
      
      // æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ã‚¯ãƒªã‚¢
      viewer.dataSources.removeAll();
      
      // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šå…ƒã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ãã®ã¾ã¾è¿½åŠ 
      dataSources.forEach((dataSource, index) => {
        try {
          viewer.dataSources.add(dataSource);
          console.log(`ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ ${index} ã‚’2Dãƒ¢ãƒ¼ãƒ‰ã§å¾©å…ƒå®Œäº†`);
        } catch (error) {
          console.error(`ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ ${index} å¾©å…ƒã‚¨ãƒ©ãƒ¼:`, error);
        }
      });
      
      // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹å¾©å…ƒãŒã†ã¾ãã„ã‹ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      setTimeout(() => {
        if (viewer.dataSources.length === 0) {
          console.log('ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹å¾©å…ƒå¤±æ•—ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆGeoJSONã‚’èª­ã¿è¾¼ã¿ã¾ã™');
          reloadDefaultGeoJSONFor2D();
        }
      }, 1000);
    }

    // Columbus Viewå°‚ç”¨ã®GeoJSONèª­ã¿è¾¼ã¿ï¼ˆåº§æ¨™å¤‰æ›å¯¾å¿œç‰ˆï¼‰
    async function reloadDataForColumbusView() {
      console.log('=== Columbus Viewç”¨GeoJSONèª­ã¿è¾¼ã¿é–‹å§‹ ===');
      
      try {
        if (!viewer) throw new Error('ViewerãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        
        console.log('ç¾åœ¨ã®ã‚·ãƒ¼ãƒ³ãƒ¢ãƒ¼ãƒ‰:', viewer.scene.mode);
        console.log('Columbus Viewã‹ç¢ºèª:', viewer.scene.mode === Cesium.SceneMode.COLUMBUS_VIEW);
        
        const geojsonPath = './data/sample.geojson';
        console.log('GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ä¸­:', geojsonPath);
        
        const response = await fetch(geojsonPath);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const geojson = await response.json();
        console.log('Columbus Viewç”¨GeoJSONãƒ‡ãƒ¼ã‚¿å–å¾—:', geojson.features.length, 'å€‹');
        
        // åº§æ¨™ç¯„å›²ã‚’ç¢ºèª
        const firstFeature = geojson.features[0];
        if (firstFeature && firstFeature.geometry && firstFeature.geometry.coordinates) {
          console.log('æœ€åˆã®ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼åº§æ¨™:', firstFeature.geometry.coordinates);
        }
        
        // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
        console.log('æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ã‚¯ãƒªã‚¢ï¼ˆç¾åœ¨:', viewer.dataSources.length, 'å€‹ï¼‰');
        viewer.dataSources.removeAll();
        
        // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ä½œæˆ
        await new Promise(resolve => setTimeout(resolve, 200));
        
        // Columbus Viewç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ä½œæˆ
        console.log('Columbus Viewç”¨ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ä½œæˆä¸­...');
        const dataSource = new Cesium.GeoJsonDataSource('Columbus_View_Data_v2');
        
        // Columbus Viewã«ç‰¹åŒ–ã—ãŸè¨­å®šã§ãƒ­ãƒ¼ãƒ‰
        await dataSource.load(geojson, {
          clampToGround: false,  // Columbus Viewã§ã‚‚åœ°é¢ã«å›ºå®šã—ãªã„
          stroke: Cesium.Color.GREEN,
          fill: Cesium.Color.GREEN.withAlpha(0.7),
          strokeWidth: 4,
          markerSize: 52,
          markerSymbol: '?',
          markerColor: Cesium.Color.GREEN,
          pixelSize: 18
        });
        
        console.log('Columbus Viewç”¨ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ä½œæˆå®Œäº†');
        
        // ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã«ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’è¿½åŠ 
        viewer.dataSources.add(dataSource);
        console.log('Columbus Viewç”¨ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã«è¿½åŠ :', viewer.dataSources.length, 'å€‹');
        
        // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚«ãƒ¡ãƒ©è¨­å®š
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // Columbus Viewç”¨ã®ã‚«ãƒ¡ãƒ©è¨­å®šï¼ˆæ±Ÿæ±åŒºä¸­å¿ƒã‚’æ˜ç¤ºçš„ã«æŒ‡å®šï¼‰
        console.log('Columbus Viewç”¨ã‚«ãƒ¡ãƒ©ã‚’è¨­å®šä¸­...');
        viewer.camera.setView({
          destination: Cesium.Cartesian3.fromDegrees(139.831, 35.681, 100000), // æ±Ÿæ±åŒºä¸­å¿ƒ
          orientation: {
            heading: 0.0,
            pitch: -Math.PI / 6,  // 30åº¦ä¸‹å‘ã
            roll: 0.0
          }
        });
        
        console.log('Columbus Viewç”¨ã‚«ãƒ¡ãƒ©è¨­å®šå®Œäº†');
        
        // ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ãˆã‚‹ã‹ã‚ºãƒ¼ãƒ ãƒ†ã‚¹ãƒˆ
        try {
          console.log('Columbus Viewãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¸ã®ã‚ºãƒ¼ãƒ ã‚’è©¦è¡Œä¸­...');
          await viewer.zoomTo(dataSource);
          console.log('Columbus Viewç”¨ã‚ºãƒ¼ãƒ æˆåŠŸ');
          
          // ã‚ºãƒ¼ãƒ å¾Œã€è¦–é‡ã‚’èª¿æ•´ï¼ˆColumbus Viewç”¨ï¼‰
          setTimeout(() => {
            const camera = viewer.camera;
            const currentPosition = camera.position;
            const cartographic = Cesium.Cartographic.fromCartesian(currentPosition);
            
            // ç¾åœ¨ä½ç½®ãŒæ—¥æœ¬ä»˜è¿‘ï¼ˆæ±çµŒ130-145åº¦ã€åŒ—ç·¯30-40åº¦ï¼‰ã«ã‚ã‚‹ã‹ç¢ºèª
            const longitude = Cesium.Math.toDegrees(cartographic.longitude);
            const latitude = Cesium.Math.toDegrees(cartographic.latitude);
            console.log('ã‚ºãƒ¼ãƒ å¾Œã®ä½ç½®:', longitude, latitude);
            
            if (longitude < 130 || longitude > 145 || latitude < 30 || latitude > 40) {
              console.warn('ä½ç½®ãŒæ—¥æœ¬ã‹ã‚‰å¤–ã‚Œã¦ã„ã¾ã™ã€‚å¼·åˆ¶çš„ã«æ±Ÿæ±åŒºã«ç§»å‹•ã—ã¾ã™ã€‚');
              // å¼·åˆ¶çš„ã«æ±Ÿæ±åŒºã«è¨­å®š
              viewer.camera.setView({
                destination: Cesium.Cartesian3.fromDegrees(139.831, 35.681, 120000),
                orientation: {
                  heading: 0.0,
                  pitch: -Math.PI / 6,
                  roll: 0.0
                }
              });
            } else {
              // é©åˆ‡ãªä½ç½®ã«ã‚ã‚‹å ´åˆã¯å°‘ã—å¼•ã
              camera.setView({
                destination: Cesium.Cartesian3.fromRadians(
                  cartographic.longitude,
                  cartographic.latitude,
                  Math.max(cartographic.height * 1.3, 120000)
                ),
                orientation: {
                  heading: 0.0,
                  pitch: -Math.PI / 6,
                  roll: 0.0
                }
              });
            }
            console.log('Columbus Viewç”¨è¦–é‡èª¿æ•´å®Œäº†');
          }, 500);
          
        } catch (zoomError) {
          console.warn('Columbus Viewã‚ºãƒ¼ãƒ å¤±æ•—ã€æ‰‹å‹•è¨­å®š:', zoomError);
          // ã‚ºãƒ¼ãƒ å¤±æ•—æ™‚ã¯å¼·åˆ¶çš„ã«æ±Ÿæ±åŒºã«è¨­å®š
          viewer.camera.setView({
            destination: Cesium.Cartesian3.fromDegrees(139.831, 35.681, 120000),
            orientation: {
              heading: 0.0,
              pitch: -Math.PI / 6,
              roll: 0.0
            }
          });
          console.log('Columbus Viewæ‰‹å‹•ã‚«ãƒ¡ãƒ©è¨­å®šå®Œäº†');
        }
        
        console.log('=== Columbus Viewç”¨GeoJSONèª­ã¿è¾¼ã¿å®Œäº† ===');
        return dataSource;
        
      } catch (error) {
        console.error('=== Columbus Viewç”¨GeoJSONèª­ã¿è¾¼ã¿å¤±æ•— ===', error);
        throw error;
      }
    }

    // Columbus Viewç”¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆGeoJSONèª­ã¿è¾¼ã¿
    async function loadDefaultGeoJSONForColumbusView() {
      console.log('Columbus Viewç”¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆGeoJSONèª­ã¿è¾¼ã¿');
      
      try {
        await reloadDataForColumbusView();
      } catch (error) {
        console.error('Columbus Viewç”¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèª­ã¿è¾¼ã¿å¤±æ•—:', error);
      }
    }

    function setupEventListeners() {
      // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
      document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file || !viewer) return;

        const reader = new FileReader();
        reader.onload = function(evt) {
          try {
            const geojson = JSON.parse(evt.target.result);
            
            // æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ã‚¯ãƒªã‚¢
            viewer.dataSources.removeAll();
            
            // GeoJSONãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ä½œæˆ
            const dataSource = new Cesium.GeoJsonDataSource();
            dataSource.load(geojson, {
              clampToGround: true,  // åœ°è¡¨é¢ã«å›ºå®š
              stroke: Cesium.Color.YELLOW,
              fill: Cesium.Color.YELLOW.withAlpha(0.5),
              strokeWidth: 3,
              markerSize: 48,  // ãƒã‚¤ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å¤§ãã
              markerSymbol: '?'  // æ˜ç¢ºãªãƒãƒ¼ã‚«ãƒ¼
            }).then(function() {
              viewer.dataSources.add(dataSource);
              viewer.zoomTo(dataSource);
              updateStatus('GeoJSONãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†');
            });
            
          } catch (err) {
            updateStatus('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + err.message);
            console.error(err);
          }
        };
        reader.readAsText(file);
      });
    }

    // å®‰å…¨ãªãƒ‡ãƒ•ã‚©ãƒ«ãƒˆGeoJSONèª­ã¿è¾¼ã¿
    async function loadDefaultGeoJSONSafe() {
      try {
        console.log('å®‰å…¨ãªGeoJSONèª­ã¿è¾¼ã¿é–‹å§‹');
        const geojsonPath = './data/sample.geojson';
        
        const response = await fetch(geojsonPath);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const geojson = await response.json();
        if (!viewer) return;
        
        const dataSource = new Cesium.GeoJsonDataSource();
        await dataSource.load(geojson, {
          clampToGround: true,
          stroke: Cesium.Color.BLUE,
          fill: Cesium.Color.BLUE.withAlpha(0.5),
          strokeWidth: 3,
          markerSize: 48,
          markerSymbol: '?'
        });
        
        viewer.dataSources.add(dataSource);
        await viewer.zoomTo(dataSource);
        updateStatus('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆGeoJSONãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºå®Œäº†');
        
        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ã«ä¿å­˜
        window.defaultGeoJSONSource = dataSource;
        
      } catch (error) {
        console.log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆGeoJSONèª­ã¿è¾¼ã¿å¤±æ•—:', error);
        updateStatus('åœ°å›³è¡¨ç¤ºæº–å‚™å®Œäº†ï¼ˆã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰');
      }
    }

    function loadDefaultGeoJSON() {
      // GitHub Pageså¯¾å¿œï¼šç›¸å¯¾ãƒ‘ã‚¹ã§ç¢ºå®Ÿã«ã‚¢ã‚¯ã‚»ã‚¹
      const geojsonPath = './data/sample.geojson';
      
      fetch(geojsonPath)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(geojson => {
          if (!viewer) return;
          
          const dataSource = new Cesium.GeoJsonDataSource();
          return dataSource.load(geojson, {
            clampToGround: true,  // åœ°è¡¨é¢ã«å›ºå®š
            stroke: Cesium.Color.BLUE,
            fill: Cesium.Color.BLUE.withAlpha(0.5),
            strokeWidth: 3,
            markerSize: 48,  // ãƒã‚¤ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å¤§ãã
            markerSymbol: '?'  // æ˜ç¢ºãªãƒãƒ¼ã‚«ãƒ¼
          });
        })
        .then(dataSource => {
          if (!viewer) return;
          viewer.dataSources.add(dataSource);
          viewer.zoomTo(dataSource);
          updateStatus('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆGeoJSONãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºå®Œäº†');
          
          // 2Dãƒ¢ãƒ¼ãƒ‰ç”¨ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
          window.defaultGeoJSONSource = dataSource;
        })
        .catch(error => {
          console.log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆGeoJSONèª­ã¿è¾¼ã¿å¤±æ•—:', error);
          updateStatus('åœ°å›³è¡¨ç¤ºæº–å‚™å®Œäº†ï¼ˆã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰');
        });
    }

    // 2Dãƒ¢ãƒ¼ãƒ‰å°‚ç”¨ã®ç¢ºå®ŸãªGeoJSONèª­ã¿è¾¼ã¿ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
    async function reload2DGeoJSON() {
      console.log('=== 2Dãƒ¢ãƒ¼ãƒ‰å°‚ç”¨GeoJSONèª­ã¿è¾¼ã¿é–‹å§‹ ===');
      
      try {
        // ã¾ãšãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã®çŠ¶æ…‹ã‚’ç¢ºèª
        if (!viewer) {
          throw new Error('ViewerãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        }
        
        console.log('ç¾åœ¨ã®ã‚·ãƒ¼ãƒ³ãƒ¢ãƒ¼ãƒ‰:', viewer.scene.mode);
        console.log('2Dãƒ¢ãƒ¼ãƒ‰ã‹ç¢ºèª:', viewer.scene.mode === Cesium.SceneMode.SCENE2D);
        
        const geojsonPath = './data/sample.geojson';
        console.log('GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ä¸­:', geojsonPath);
        
        const response = await fetch(geojsonPath);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const geojson = await response.json();
        console.log('GeoJSONãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†:', geojson.features.length, 'å€‹ã®ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼');
        
        // åº§æ¨™ç¯„å›²ã‚’ç¢ºèª
        const firstFeature = geojson.features[0];
        if (firstFeature && firstFeature.geometry && firstFeature.geometry.coordinates) {
          console.log('æœ€åˆã®ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼åº§æ¨™:', firstFeature.geometry.coordinates);
        }
        
        // æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’å®Œå…¨ã«ã‚¯ãƒªã‚¢
        console.log('æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ã‚¯ãƒªã‚¢ï¼ˆç¾åœ¨:', viewer.dataSources.length, 'å€‹ï¼‰');
        viewer.dataSources.removeAll();
        
        // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ä½œæˆ
        await new Promise(resolve => setTimeout(resolve, 200));
        
        // 2Dãƒ¢ãƒ¼ãƒ‰å°‚ç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ä½œæˆ
        console.log('2Dãƒ¢ãƒ¼ãƒ‰ç”¨ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ä½œæˆä¸­...');
        const dataSource = new Cesium.GeoJsonDataSource('2D_Mode_Data_v2');
        
        // 2Dãƒ¢ãƒ¼ãƒ‰ã«ç‰¹åŒ–ã—ãŸè¨­å®šã§ãƒ­ãƒ¼ãƒ‰
        await dataSource.load(geojson, {
          clampToGround: false,  // 2Dã§ã¯åœ°é¢ã«å›ºå®šã—ãªã„
          stroke: Cesium.Color.RED,
          fill: Cesium.Color.RED.withAlpha(0.7),
          strokeWidth: 5,
          markerSize: 64,  // 2Dã§ã¯å¤§ãã‚ã®ãƒãƒ¼ã‚«ãƒ¼
          markerSymbol: '?',
          markerColor: Cesium.Color.RED,
          pixelSize: 20  // ãƒ”ã‚¯ã‚»ãƒ«ã‚µã‚¤ã‚ºã‚‚æŒ‡å®š
        });
        
        console.log('2Dãƒ¢ãƒ¼ãƒ‰ç”¨ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ä½œæˆå®Œäº†');
        
        // ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã«ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’è¿½åŠ 
        viewer.dataSources.add(dataSource);
        console.log('ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã«è¿½åŠ :', viewer.dataSources.length, 'å€‹');
        
        // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚«ãƒ¡ãƒ©è¨­å®š
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // 2Dãƒ¢ãƒ¼ãƒ‰ç”¨ã®ã‚«ãƒ¡ãƒ©è¨­å®šï¼ˆæ±Ÿæ±åŒºä¸­å¿ƒï¼‰
        console.log('2Dãƒ¢ãƒ¼ãƒ‰ç”¨ã‚«ãƒ¡ãƒ©ã‚’è¨­å®šä¸­...');
        viewer.camera.setView({
          destination: Cesium.Cartesian3.fromDegrees(139.831, 35.681, 200000), // é«˜åº¦ã‚’ä¸Šã’ã‚‹
          orientation: {
            heading: 0.0,
            pitch: -Math.PI / 2,  // çœŸä¸‹ã‚’å‘ã
            roll: 0.0
          }
        });
        
        console.log('2Dãƒ¢ãƒ¼ãƒ‰ç”¨ã‚«ãƒ¡ãƒ©è¨­å®šå®Œäº†');
        
        // ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ãˆã‚‹ã‹ã‚ºãƒ¼ãƒ ãƒ†ã‚¹ãƒˆ
        try {
          console.log('ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¸ã®ã‚ºãƒ¼ãƒ ã‚’è©¦è¡Œä¸­...');
          await viewer.zoomTo(dataSource);
          console.log('2Dãƒ¢ãƒ¼ãƒ‰ç”¨ã‚ºãƒ¼ãƒ æˆåŠŸ');
          
          // ã‚ºãƒ¼ãƒ å¾Œã€è¦–é‡ã‚’èª¿æ•´
          setTimeout(() => {
            const camera = viewer.camera;
            const currentPosition = camera.position;
            const cartographic = Cesium.Cartographic.fromCartesian(currentPosition);
            
            // ç¾åœ¨ä½ç½®ãŒæ—¥æœ¬ä»˜è¿‘ï¼ˆæ±çµŒ130-145åº¦ã€åŒ—ç·¯30-40åº¦ï¼‰ã«ã‚ã‚‹ã‹ç¢ºèª
            const longitude = Cesium.Math.toDegrees(cartographic.longitude);
            const latitude = Cesium.Math.toDegrees(cartographic.latitude);
            console.log('ã‚ºãƒ¼ãƒ å¾Œã®2Dãƒ¢ãƒ¼ãƒ‰ä½ç½®:', longitude, latitude);
            
            if (longitude < 130 || longitude > 145 || latitude < 30 || latitude > 40) {
              console.warn('2Dãƒ¢ãƒ¼ãƒ‰ã§ä½ç½®ãŒæ—¥æœ¬ã‹ã‚‰å¤–ã‚Œã¦ã„ã¾ã™ã€‚å¼·åˆ¶çš„ã«æ±Ÿæ±åŒºã«ç§»å‹•ã—ã¾ã™ã€‚');
              // å¼·åˆ¶çš„ã«æ±Ÿæ±åŒºã«è¨­å®š
              viewer.camera.setView({
                destination: Cesium.Cartesian3.fromDegrees(139.831, 35.681, 250000),
                orientation: {
                  heading: 0.0,
                  pitch: -Math.PI / 2,
                  roll: 0.0
                }
              });
              console.log('2Dãƒ¢ãƒ¼ãƒ‰ä½ç½®ã‚’å¼·åˆ¶ä¿®æ­£å®Œäº†');
            } else {
              // é©åˆ‡ãªä½ç½®ã«ã‚ã‚‹å ´åˆã¯å°‘ã—å¼•ã
              camera.setView({
                destination: Cesium.Cartesian3.fromRadians(
                  cartographic.longitude,
                  cartographic.latitude,
                  Math.max(cartographic.height * 1.5, 250000)  // ã•ã‚‰ã«å¼•ã
                ),
                orientation: {
                  heading: 0.0,
                  pitch: -Math.PI / 2,
                  roll: 0.0
                }
              });
              console.log('2Dãƒ¢ãƒ¼ãƒ‰ç”¨è¦–é‡èª¿æ•´å®Œäº†');
            }
          }, 500);
          
        } catch (zoomError) {
          console.warn('2Dã‚ºãƒ¼ãƒ å¤±æ•—ã€æ‰‹å‹•ã‚«ãƒ¡ãƒ©è¨­å®š:', zoomError);
          // ã‚ºãƒ¼ãƒ å¤±æ•—æ™‚ã¯æ‰‹å‹•ã§ã‚«ãƒ¡ãƒ©è¨­å®š
          viewer.camera.setView({
            destination: Cesium.Cartesian3.fromDegrees(139.831, 35.681, 250000),
            orientation: {
              heading: 0.0,
              pitch: -Math.PI / 2,
              roll: 0.0
            }
          });
          console.log('2Dãƒ¢ãƒ¼ãƒ‰æ‰‹å‹•ã‚«ãƒ¡ãƒ©è¨­å®šå®Œäº†');
        }
        
        console.log('=== 2Dãƒ¢ãƒ¼ãƒ‰å°‚ç”¨GeoJSONèª­ã¿è¾¼ã¿å®Œäº† ===');
        return dataSource;
        
      } catch (error) {
        console.error('=== 2Dãƒ¢ãƒ¼ãƒ‰GeoJSONèª­ã¿è¾¼ã¿å¤±æ•— ===', error);
        throw error;
      }
    }

    // 2Dãƒ¢ãƒ¼ãƒ‰å°‚ç”¨ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆGeoJSONå†èª­ã¿è¾¼ã¿ï¼ˆç°¡ç•¥åŒ–ç‰ˆï¼‰
    function reloadDefaultGeoJSONFor2D() {
      console.log('2Dãƒ¢ãƒ¼ãƒ‰ç”¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆGeoJSONèª­ã¿è¾¼ã¿é–‹å§‹');
      const geojsonPath = './data/sample.geojson';
      
      fetch(geojsonPath)
        .then(response => response.json())
        .then(geojson => {
          if (!viewer) return;
          
          // æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ã‚¯ãƒªã‚¢
          viewer.dataSources.removeAll();
          
          const dataSource = new Cesium.GeoJsonDataSource('Default2D');
          return dataSource.load(geojson, {
            clampToGround: true,
            stroke: Cesium.Color.BLUE,
            fill: Cesium.Color.BLUE.withAlpha(0.5),
            strokeWidth: 3,
            markerSize: 48,
            markerSymbol: '?'
          });
        })
        .then(dataSource => {
          if (!viewer) return;
          viewer.dataSources.add(dataSource);
          console.log('2Dãƒ¢ãƒ¼ãƒ‰ç”¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆGeoJSONèª­ã¿è¾¼ã¿å®Œäº†');
          
          // ãƒ‡ãƒ¼ã‚¿ä¸­å¿ƒã«ã‚ºãƒ¼ãƒ ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
          setTimeout(() => {
            viewer.zoomTo(dataSource).catch(error => {
              console.log('2Dã‚ºãƒ¼ãƒ ã‚¨ãƒ©ãƒ¼ï¼ˆé€šå¸¸ï¼‰:', error);
              // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šæ‰‹å‹•ã§ã‚«ãƒ¡ãƒ©è¨­å®š
              viewer.camera.setView({
                destination: Cesium.Cartesian3.fromDegrees(139.831, 35.681, 120000),
                orientation: {
                  heading: 0.0,
                  pitch: -Math.PI / 2,
                  roll: 0.0
                }
              });
            });
          }, 500);
        })
        .catch(error => {
          console.error('2Dãƒ¢ãƒ¼ãƒ‰ç”¨GeoJSONèª­ã¿è¾¼ã¿å¤±æ•—:', error);
          updateStatus('2Dãƒ¢ãƒ¼ãƒ‰ï¼šGeoJSONèª­ã¿è¾¼ã¿å¤±æ•—');
        });
    }

    // Columbus Viewç”¨ã®ç·Šæ€¥åº§æ¨™ä¿®æ­£æ©Ÿèƒ½
    function forceFixColumbusViewPosition() {
      if (!viewer || viewer.scene.mode !== Cesium.SceneMode.COLUMBUS_VIEW) {
        return;
      }
      
      console.log('Columbus Viewåº§æ¨™ä¿®æ­£ãƒã‚§ãƒƒã‚¯é–‹å§‹');
      
      const camera = viewer.camera;
      const currentPosition = camera.position;
      const cartographic = Cesium.Cartographic.fromCartesian(currentPosition);
      const longitude = Cesium.Math.toDegrees(cartographic.longitude);
      const latitude = Cesium.Math.toDegrees(cartographic.latitude);
      
      console.log('ç¾åœ¨ã®Columbus Viewä½ç½®:', longitude, latitude);
      
      // æ—¥æœ¬ã‹ã‚‰å¤§ããå¤–ã‚Œã¦ã„ã‚‹å ´åˆï¼ˆã‚¢ãƒ•ãƒªã‚«ãªã©ï¼‰ã¯å¼·åˆ¶ä¿®æ­£
      if (longitude < 120 || longitude > 150 || latitude < 20 || latitude > 50) {
        console.warn('Columbus Viewã§ä½ç½®ãŒæ—¥æœ¬ã‹ã‚‰å¤§ããå¤–ã‚Œã¦ã„ã¾ã™ã€‚å¼·åˆ¶ä¿®æ­£ã—ã¾ã™ã€‚');
        console.log('ä¿®æ­£å‰ã®ä½ç½®:', longitude, latitude);
        
        viewer.camera.setView({
          destination: Cesium.Cartesian3.fromDegrees(139.831, 35.681, 120000),
          orientation: {
            heading: 0.0,
            pitch: -Math.PI / 6,
            roll: 0.0
          }
        });
        
        console.log('Columbus Viewä½ç½®ã‚’æ±Ÿæ±åŒºã«ä¿®æ­£å®Œäº†');
        return true;
      }
      
      console.log('Columbus Viewä½ç½®ã¯æ­£å¸¸ç¯„å›²å†…ã§ã™');
      return false;
    }

    // 2Dãƒ¢ãƒ¼ãƒ‰ç”¨ã®ç·Šæ€¥åº§æ¨™ä¿®æ­£æ©Ÿèƒ½
    function forceFixScene2DPosition() {
      if (!viewer || viewer.scene.mode !== Cesium.SceneMode.SCENE2D) {
        return;
      }
      
      console.log('2Dãƒ¢ãƒ¼ãƒ‰åº§æ¨™ä¿®æ­£ãƒã‚§ãƒƒã‚¯é–‹å§‹');
      
      const camera = viewer.camera;
      const currentPosition = camera.position;
      const cartographic = Cesium.Cartographic.fromCartesian(currentPosition);
      const longitude = Cesium.Math.toDegrees(cartographic.longitude);
      const latitude = Cesium.Math.toDegrees(cartographic.latitude);
      
      console.log('ç¾åœ¨ã®2Dãƒ¢ãƒ¼ãƒ‰ä½ç½®:', longitude, latitude);
      
      // æ—¥æœ¬ã‹ã‚‰å¤§ããå¤–ã‚Œã¦ã„ã‚‹å ´åˆï¼ˆã‚¢ãƒ•ãƒªã‚«ãªã©ï¼‰ã¯å¼·åˆ¶ä¿®æ­£
      if (longitude < 120 || longitude > 150 || latitude < 20 || latitude > 50) {
        console.warn('2Dãƒ¢ãƒ¼ãƒ‰ã§ä½ç½®ãŒæ—¥æœ¬ã‹ã‚‰å¤§ããå¤–ã‚Œã¦ã„ã¾ã™ã€‚å¼·åˆ¶ä¿®æ­£ã—ã¾ã™ã€‚');
        console.log('ä¿®æ­£å‰ã®ä½ç½®:', longitude, latitude);
        
        viewer.camera.setView({
          destination: Cesium.Cartesian3.fromDegrees(139.831, 35.681, 200000),
          orientation: {
            heading: 0.0,
            pitch: -Math.PI / 2,  // çœŸä¸‹ã‚’å‘ã
            roll: 0.0
          }
        });
        
        console.log('2Dãƒ¢ãƒ¼ãƒ‰ä½ç½®ã‚’æ±Ÿæ±åŒºã«ä¿®æ­£å®Œäº†');
        return true;
      }
      
      console.log('2Dãƒ¢ãƒ¼ãƒ‰ä½ç½®ã¯æ­£å¸¸ç¯„å›²å†…ã§ã™');
      return false;
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«åˆæœŸåŒ–ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ï¼‰
    document.addEventListener('DOMContentLoaded', async function() {
      try {
        await initializeCesium();
      } catch (error) {
        console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        updateStatus('åœ°å›³ã®åˆæœŸåŒ–ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
      }
    });

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
    window.addEventListener('error', function(event) {
      console.log('ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼:', event.error);
    });

    window.addEventListener('unhandledrejection', function(event) {
      console.log('æœªå‡¦ç†ã®Promiseæ‹’å¦:', event.reason);
      event.preventDefault(); // ã‚¨ãƒ©ãƒ¼ã®ä¼æ’­ã‚’æ­¢ã‚ã‚‹
    });
  </script>
</body>
</html>
