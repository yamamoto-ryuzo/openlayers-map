<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Cesium 3D GeoJSON Viewer - GitHub Pagesç‰ˆ</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    body { margin: 0; padding: 10px; font-family: Arial, sans-serif; }
    h1 { margin: 0 0 10px 0; }
    #cesiumContainer { width: 100%; height: 600px; display: block; border: 1px solid #ccc; }
    #fileInput { margin: 10px 0; }
    #status { margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 4px; }
    .retry-button { 
      margin: 10px 0; 
      padding: 10px 20px; 
      background: #007bff; 
      color: white; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
    }
    .retry-button:hover { background: #0056b3; }
  </style>
</head>
<body>
  <h1>ğŸŒ Cesium 3D GeoJSON Viewer (GitHub Pagesç‰ˆ)</h1>
  <div style="margin: 10px 0; padding: 10px; background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 4px;">
    <strong>ğŸ“ å‹•ä½œç¢ºèªæ¸ˆã¿:</strong> VS Codeãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®å‹•ä½œã‚’åŸºã«GitHub Pagesç”¨ã«æœ€é©åŒ–
  </div>
  <div style="margin: 10px 0; padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px;">
    <strong>âš ï¸ é‡è¦ãªæ³¨æ„äº‹é …:</strong><br>
    â€¢ èƒŒæ™¯åœ°å›³ã®èª­ã¿è¾¼ã¿ã«ã¯<strong>5-10ç§’é–“ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ</strong>ãŒå¿…è¦ã§ã™<br>
    â€¢ åˆå›è¡¨ç¤ºæ™‚ã‚„é…ã„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§ã¯èƒŒæ™¯ãŒé…ã‚Œã¦è¡¨ç¤ºã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™<br>
    â€¢ èƒŒæ™¯ãŒè¡¨ç¤ºã•ã‚Œãªã„å ´åˆã¯<strong>20-30ç§’</strong>ãŠå¾…ã¡ãã ã•ã„<br>
    â€¢ GitHub Pagesã®å¤–éƒ¨ã‚¿ã‚¤ãƒ«ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚»ã‚¹ã«ã¯æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™<br>
    â€¢ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒé…ã„å ´åˆã¯ã€ã•ã‚‰ã«æ™‚é–“ãŒã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™
  </div>
  <div id="status">åˆæœŸåŒ–ä¸­...</div>
  <button class="retry-button" onclick="retryMapLoad()" style="display: none;" id="retryButton">
    ğŸ”„ èƒŒæ™¯åœ°å›³ã®å†èª­ã¿è¾¼ã¿
  </button>
  <input type="file" id="fileInput" accept=".geojson,.json" />
  <div id="cesiumContainer"></div>
  
  <script>
    const statusDiv = document.getElementById('status');
    let viewer = null;
    
    function updateStatus(message) {
      statusDiv.textContent = message;
      console.log(message);
    }

    // æ®µéšçš„åˆæœŸåŒ–
    async function initializeCesium() {
      updateStatus('Cesiumãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã‚’åˆæœŸåŒ–ä¸­...');
      
      try {
        // æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªè¨­å®šã§é–‹å§‹
        viewer = new Cesium.Viewer('cesiumContainer', {
          imageryProvider: false,
          baseLayerPicker: false,
          vrButton: false,
          geocoder: false,
          homeButton: true,
          sceneModePicker: false,
          navigationHelpButton: false,
          animation: false,
          timeline: false,
          fullscreenButton: true
        });

        updateStatus('ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ä½œæˆå®Œäº†ã€‚èƒŒæ™¯åœ°å›³ã‚’è¨­å®šä¸­...');

        // èƒŒæ™¯ã‚’ä¸€æ™‚çš„ã«å˜è‰²ã«è¨­å®š
        viewer.scene.globe.show = false;
        viewer.scene.backgroundColor = Cesium.Color.LIGHTSTEELBLUE;

        // æ®µéšçš„èª­ã¿è¾¼ã¿: ã¾ãšåŸºæœ¬çš„ãªåœ°çƒã‚’è¡¨ç¤ºã—ã¦ã‹ã‚‰èƒŒæ™¯ã‚’è¿½åŠ 
        setTimeout(() => {
          updateStatus('Step 1: åŸºæœ¬åœ°çƒã‚’è¡¨ç¤ºä¸­...');
          viewer.scene.globe.show = true;
          viewer.scene.backgroundColor = Cesium.Color.LIGHTSTEELBLUE;
          
          // ã•ã‚‰ã«å¾…ã£ã¦ã‹ã‚‰OpenStreetMapã‚’è¿½åŠ 
          setTimeout(() => {
            try {
              updateStatus('Step 2: OpenStreetMapã‚’èª­ã¿è¾¼ã¿ä¸­... (æœ€å¤§30ç§’ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™)');
              
              const osmProvider = new Cesium.UrlTemplateImageryProvider({
                url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                subdomains: ['a', 'b', 'c'],
                maximumLevel: 19,
                minimumLevel: 0,
                credit: 'Map data Â© OpenStreetMap contributors',
                enablePickFeatures: false
              });

              viewer.scene.imageryLayers.addImageryProvider(osmProvider);
              
              updateStatus('Step 3: OpenStreetMapè¿½åŠ å®Œäº†ã€‚ã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿ä¸­...');

              // æ±äº¬ã‚’ä¸­å¿ƒã«è¨­å®šï¼ˆã‚ˆã‚Šè©³ç´°ãªè¨­å®šï¼‰
              viewer.camera.setView({
                destination: Cesium.Cartesian3.fromDegrees(139.767, 35.681, 50000),
                orientation: {
                  heading: 0.0,
                  pitch: -Math.PI / 4,  // 45åº¦ä¸‹å‘ã
                  roll: 0.0
                }
              });

              // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
              setupEventListeners();
              
              // ã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿ç›£è¦–ã‚’è¿½åŠ 
              monitorTileLoading();
              
              // ã•ã‚‰ã«æ™‚é–“ã‚’ãŠã„ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆGeoJSONã‚’èª­ã¿è¾¼ã¿
              setTimeout(() => {
                loadDefaultGeoJSON();
              }, 2000);

            } catch (osmError) {
              console.error('OpenStreetMapèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', osmError);
              updateStatus('OpenStreetMapèª­ã¿è¾¼ã¿å¤±æ•—ã€‚åŸºæœ¬è¡¨ç¤ºã§ç¶™ç¶šã—ã¾ã™ã€‚');
              
              // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: åŸºæœ¬è¡¨ç¤ºã§ã‚‚æ“ä½œå¯èƒ½ã«ã™ã‚‹
              setupEventListeners();
              loadDefaultGeoJSON();
            }
          }, 5000);  // 5ç§’å¾…æ©Ÿã—ã¦ã‹ã‚‰OpenStreetMapèª­ã¿è¾¼ã¿
          
        }, 2000);  // ã¾ãš2ç§’å¾…æ©Ÿã—ã¦ã‹ã‚‰åŸºæœ¬åœ°çƒè¡¨ç¤º

      } catch (error) {
        console.error('CesiumåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        updateStatus('Cesiumã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        document.getElementById('cesiumContainer').innerHTML = 
          '<div style="padding: 20px; color: red; text-align: center;">3Dåœ°å›³ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ<br>' + 
          'ãƒ–ãƒ©ã‚¦ã‚¶ã‚’æ›´æ–°ã™ã‚‹ã‹ã€index2d.htmlã‚’è©¦ã—ã¦ãã ã•ã„</div>';
      }
    }

    // ã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿ç›£è¦–
    function monitorTileLoading() {
      if (!viewer || !viewer.scene || !viewer.scene.globe) return;

      let tileLoadCount = 0;
      const startTime = Date.now();

      const checkTiles = setInterval(() => {
        const tilesLoaded = viewer.scene.globe.tilesLoaded;
        if (tilesLoaded) {
          tileLoadCount++;
          const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
          updateStatus(`âœ… OpenStreetMapã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†ï¼ (${elapsed}ç§’)`);
          clearInterval(checkTiles);
        }
      }, 500);

      // 30ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè­¦å‘Šã¨ãƒªãƒˆãƒ©ã‚¤ãƒœã‚¿ãƒ³è¡¨ç¤º
      setTimeout(() => {
        clearInterval(checkTiles);
        if (tileLoadCount === 0) {
          updateStatus('âš ï¸ ã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿ãŒé…ã‚Œã¦ã„ã¾ã™ã€‚ä¸‹ã®ãƒœã‚¿ãƒ³ã§å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
          document.getElementById('retryButton').style.display = 'block';
        }
      }, 30000);
    }

    // èƒŒæ™¯åœ°å›³ã®å†èª­ã¿è¾¼ã¿æ©Ÿèƒ½
    function retryMapLoad() {
      updateStatus('èƒŒæ™¯åœ°å›³ã‚’å†èª­ã¿è¾¼ã¿ä¸­...');
      document.getElementById('retryButton').style.display = 'none';
      
      if (viewer && viewer.scene && viewer.scene.imageryLayers) {
        viewer.scene.imageryLayers.removeAll();
        
        setTimeout(() => {
          try {
            const osmProvider = new Cesium.UrlTemplateImageryProvider({
              url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
              subdomains: ['a', 'b', 'c'],
              maximumLevel: 19,
              minimumLevel: 0,
              credit: 'Map data Â© OpenStreetMap contributors',
              enablePickFeatures: false
            });

            viewer.scene.imageryLayers.addImageryProvider(osmProvider);
            updateStatus('èƒŒæ™¯åœ°å›³ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã—ãŸã€‚ã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿ä¸­...');
            monitorTileLoading();
            
          } catch (error) {
            updateStatus('å†èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            document.getElementById('retryButton').style.display = 'block';
          }
        }, 1000);
      }
    }

    function setupEventListeners() {
      // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
      document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file || !viewer) return;

        const reader = new FileReader();
        reader.onload = function(evt) {
          try {
            const geojson = JSON.parse(evt.target.result);
            
            // æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ã‚¯ãƒªã‚¢
            viewer.dataSources.removeAll();
            
            // GeoJSONãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ä½œæˆ
            const dataSource = new Cesium.GeoJsonDataSource();
            dataSource.load(geojson, {
              clampToGround: true,
              stroke: Cesium.Color.YELLOW,
              fill: Cesium.Color.YELLOW.withAlpha(0.5),
              strokeWidth: 3
            }).then(function() {
              viewer.dataSources.add(dataSource);
              viewer.zoomTo(dataSource);
              updateStatus('GeoJSONãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†');
            });
            
          } catch (err) {
            updateStatus('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + err.message);
            console.error(err);
          }
        };
        reader.readAsText(file);
      });
    }

    function loadDefaultGeoJSON() {
      // GitHub Pageså¯¾å¿œï¼šç›¸å¯¾ãƒ‘ã‚¹ã§ç¢ºå®Ÿã«ã‚¢ã‚¯ã‚»ã‚¹
      const geojsonPath = './data/sample.geojson';
      
      fetch(geojsonPath)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(geojson => {
          if (!viewer) return;
          
          const dataSource = new Cesium.GeoJsonDataSource();
          return dataSource.load(geojson, {
            clampToGround: true,
            stroke: Cesium.Color.BLUE,
            fill: Cesium.Color.BLUE.withAlpha(0.5),
            strokeWidth: 3
          });
        })
        .then(dataSource => {
          if (!viewer) return;
          viewer.dataSources.add(dataSource);
          viewer.zoomTo(dataSource);
          updateStatus('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆGeoJSONãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºå®Œäº†');
        })
        .catch(error => {
          console.log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆGeoJSONèª­ã¿è¾¼ã¿å¤±æ•—:', error);
          updateStatus('åœ°å›³è¡¨ç¤ºæº–å‚™å®Œäº†ï¼ˆã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰');
        });
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', initializeCesium);
  </script>
</body>
</html>
