<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Cesium 3D GeoJSON Viewer</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    body { margin: 0; padding: 10px; font-family: Arial, sans-serif; }
    h1 { margin: 0 0 10px 0; }
    #cesiumContainer { width: 100%; height: 600px; display: block; border: 1px solid #ccc; }
    #fileInput { margin: 10px 0; }
    #status { margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>Cesium 3D GeoJSON Viewer</h1>
  <div id="status">初期化中...</div>
  <input type="file" id="fileInput" accept=".geojson,.json" />
  <div id="cesiumContainer"></div>
  
  <script>
    // Cesium Ion を無効化してOpenStreetMapのみ使用
    Cesium.Ion.defaultAccessToken = '';
    
    const statusDiv = document.getElementById('status');
    let viewer = null;
    
    function updateStatus(message) {
      statusDiv.textContent = message;
      console.log(message);
    }

    // 段階的初期化 - 複数のフォールバック戦略
    async function initializeCesium() {
      updateStatus('Cesiumビューワーを初期化中...');
      console.log('Cesium初期化開始 - URL:', window.location.href);
      console.log('Cesium Ion Token:', Cesium.Ion.defaultAccessToken);
      
      try {
        // タイルサーバーの優先順位リスト
        const tileProviders = [
          {
            name: 'OpenStreetMap (subdomain)',
            config: {
              url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
              subdomains: ['a', 'b', 'c'],
              maximumLevel: 18,
              credit: 'Map data © OpenStreetMap contributors'
            }
          },
          {
            name: 'OpenStreetMap (direct)',
            config: {
              url: 'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
              maximumLevel: 18,
              credit: 'Map data © OpenStreetMap contributors'
            }
          },
          {
            name: 'CartoDB Positron',
            config: {
              url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',
              subdomains: ['a', 'b', 'c', 'd'],
              maximumLevel: 18,
              credit: '© CartoDB © OpenStreetMap contributors'
            }
          }
        ];

        for (let i = 0; i < tileProviders.length; i++) {
          const provider = tileProviders[i];
          
          try {
            updateStatus(`${provider.name}を試行中...`);
            console.log(`Trying provider: ${provider.name}`);
            
            const imageryProvider = new Cesium.UrlTemplateImageryProvider(provider.config);

            console.log('ImageryProvider created, creating viewer...');
            updateStatus('Cesiumビューワーを作成中...');

            viewer = new Cesium.Viewer('cesiumContainer', {
              imageryProvider: imageryProvider,
              baseLayerPicker: false,
              vrButton: false,
              geocoder: false,
              homeButton: true,
              sceneModePicker: false,
              navigationHelpButton: false,
              animation: false,
              timeline: false,
              fullscreenButton: true
            });

            console.log('Cesiumビューワー作成完了');
            updateStatus(`✅ ${provider.name}で初期化完了！東京に移動中...`);

            // 東京を中心に設定
            viewer.camera.setView({
              destination: Cesium.Cartesian3.fromDegrees(139.767, 35.681, 50000)
            });

            console.log('東京への移動完了');
            updateStatus(`✅ 3D地図表示完了！(${provider.name})`);

            // イベントリスナーを設定
            setupEventListeners();
            
            // デフォルトGeoJSONを読み込み
            loadDefaultGeoJSON();
            
            // 成功したらループを抜ける
            return;
            
          } catch (providerError) {
            console.error(`${provider.name} failed:`, providerError);
            updateStatus(`${provider.name} 失敗、次を試行中...`);
            
            // viewerが作成されていたら破棄
            if (viewer) {
              try {
                viewer.destroy();
                viewer = null;
              } catch (destroyError) {
                console.error('Viewer destroy error:', destroyError);
              }
            }
            
            // 最後のプロバイダーでも失敗した場合
            if (i === tileProviders.length - 1) {
              throw new Error('すべてのタイルプロバイダーで初期化に失敗しました');
            }
          }
        }

      } catch (error) {
        console.error('Cesium初期化エラー:', error);
        updateStatus('Cesiumの初期化に失敗しました: ' + error.message);
        document.getElementById('cesiumContainer').innerHTML = 
          '<div style="padding: 20px; color: red; text-align: center;">3D地図の表示に失敗しました<br>' + 
          'ブラウザを更新するか、index2d.htmlを試してください</div>';
      }
    }

    function setupEventListeners() {
      // ファイル選択イベント
      document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file || !viewer) return;

        const reader = new FileReader();
        reader.onload = function(evt) {
          try {
            const geojson = JSON.parse(evt.target.result);
            
            // 既存のデータソースをクリア
            viewer.dataSources.removeAll();
            
            // GeoJSONデータソースを作成
            const dataSource = new Cesium.GeoJsonDataSource();
            dataSource.load(geojson, {
              clampToGround: true,
              stroke: Cesium.Color.YELLOW,
              fill: Cesium.Color.YELLOW.withAlpha(0.5),
              strokeWidth: 3
            }).then(function() {
              viewer.dataSources.add(dataSource);
              viewer.zoomTo(dataSource);
              updateStatus('GeoJSONファイル読み込み完了');
            });
            
          } catch (err) {
            updateStatus('ファイル読み込みエラー: ' + err.message);
            console.error(err);
          }
        };
        reader.readAsText(file);
      });
    }

    function loadDefaultGeoJSON() {
      // GitHub Pages対応：相対パスで確実にアクセス
      const geojsonPath = './data/sample.geojson';
      
      fetch(geojsonPath)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(geojson => {
          if (!viewer) return;
          
          const dataSource = new Cesium.GeoJsonDataSource();
          return dataSource.load(geojson, {
            clampToGround: true,
            stroke: Cesium.Color.BLUE,
            fill: Cesium.Color.BLUE.withAlpha(0.5),
            strokeWidth: 3
          });
        })
        .then(dataSource => {
          if (!viewer) return;
          viewer.dataSources.add(dataSource);
          viewer.zoomTo(dataSource);
          updateStatus('デフォルトGeoJSONデータ表示完了');
        })
        .catch(error => {
          console.log('デフォルトGeoJSON読み込み失敗:', error);
          updateStatus('地図表示準備完了（サンプルデータなし）');
        });
    }

    // ページ読み込み完了後に初期化
    document.addEventListener('DOMContentLoaded', initializeCesium);
  </script>
</body>
</html>
