<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>GitHub Pageså¯¾å¿œ Cesium 3D GeoJSON Viewer</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    body { margin: 0; padding: 10px; font-family: Arial, sans-serif; }
    h1 { margin: 0 0 10px 0; color: #333; }
    #cesiumContainer { width: 100%; height: 600px; display: block; border: 2px solid #333; }
    #fileInput { margin: 10px 0; }
    #status { 
      margin: 10px 0; 
      padding: 15px; 
      background: #e7f3ff; 
      border: 1px solid #b3d9ff; 
      border-radius: 4px; 
      font-weight: bold;
    }
    .success { background: #d4edda; color: #155724; border-color: #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
    .info-panel {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 15px;
      margin: 10px 0;
      border-radius: 4px;
    }
    .controls {
      margin: 10px 0;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    button {
      margin: 5px;
      padding: 8px 16px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover { background: #0056b3; }
    button:disabled { background: #6c757d; cursor: not-allowed; }
  </style>
</head>
<body>
  <h1>ğŸŒ GitHub Pageså¯¾å¿œ Cesium 3D GeoJSON Viewer</h1>
  
  <div class="info-panel">
    <strong>ğŸ“ ã”æ¡ˆå†…:</strong> 
    GitHub Pagesç’°å¢ƒã§ã¯å¤–éƒ¨ã‚¿ã‚¤ãƒ«ã‚µãƒ¼ãƒãƒ¼ãŒåˆ©ç”¨ã§ããªã„ãŸã‚ã€ã‚·ãƒ³ãƒ—ãƒ«ãªèƒŒæ™¯è‰²ã§3Dè¡¨ç¤ºã—ã¾ã™ã€‚
    GeoJSONãƒ‡ãƒ¼ã‚¿ã¯æ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã€3Dæ“ä½œã‚‚å®Œå…¨ã«åˆ©ç”¨ã§ãã¾ã™ã€‚
  </div>
  
  <div id="status">åˆæœŸåŒ–ä¸­...</div>
  
  <div class="controls">
    <input type="file" id="fileInput" accept=".geojson,.json" />
    <button onclick="loadSampleData()">ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿</button>
    <button onclick="resetView()">æ±äº¬ã«æˆ»ã‚‹</button>
    <button onclick="toggleWireframe()">ãƒ¯ã‚¤ãƒ¤ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ åˆ‡æ›¿</button>
  </div>
  
  <div id="cesiumContainer"></div>
  
  <script>
    // Cesium Ion ã‚’ç„¡åŠ¹åŒ–
    Cesium.Ion.defaultAccessToken = '';
    
    const statusDiv = document.getElementById('status');
    let viewer = null;
    let wireframeMode = false;
    
    function updateStatus(message, type = 'info') {
      statusDiv.textContent = message;
      statusDiv.className = type;
      console.log(message);
    }

    // CesiumåˆæœŸåŒ–
    async function initializeCesium() {
      updateStatus('Cesium 3Dãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã‚’åˆæœŸåŒ–ä¸­...', 'info');
      
      try {
        viewer = new Cesium.Viewer('cesiumContainer', {
          imageryProvider: false,  // å¤–éƒ¨ã‚¿ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ãªã„
          terrainProvider: false,
          skyBox: false,
          skyAtmosphere: false,
          baseLayerPicker: false,
          vrButton: false,
          geocoder: false,
          homeButton: true,
          sceneModePicker: true,   // 2D/3Dåˆ‡ã‚Šæ›¿ãˆã‚’æœ‰åŠ¹
          navigationHelpButton: true,
          animation: false,
          timeline: false,
          fullscreenButton: true
        });

        // ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯ã‚’è¨­å®š
        viewer.scene.backgroundColor = Cesium.Color.fromCssColorString('#87CEEB');
        viewer.scene.globe.show = false;

        // ãƒ•ã‚©ã‚°ã‚’ç„¡åŠ¹åŒ–ã—ã¦é ãã¾ã§è¦‹ãˆã‚‹ã‚ˆã†ã«
        viewer.scene.fog.enabled = false;

        updateStatus('âœ… 3Dãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼åˆæœŸåŒ–å®Œäº†ï¼', 'success');

        // æ±äº¬ã‚’ä¸­å¿ƒã«è¨­å®š
        viewer.camera.setView({
          destination: Cesium.Cartesian3.fromDegrees(139.767, 35.681, 50000),
          orientation: {
            heading: 0.0,
            pitch: -Math.PI / 6,  // 30åº¦ä¸‹å‘ã
            roll: 0.0
          }
        });

        // åº§æ¨™ã‚°ãƒªãƒƒãƒ‰ã‚’è¿½åŠ 
        addCoordinateGrid();

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        setupEventListeners();
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆGeoJSONã‚’èª­ã¿è¾¼ã¿
        loadDefaultGeoJSON();

      } catch (error) {
        console.error('CesiumåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        updateStatus('âŒ åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
        document.getElementById('cesiumContainer').innerHTML = 
          '<div style="padding: 20px; color: red; text-align: center;">3Dåœ°å›³ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ<br>' + 
          'ãƒ–ãƒ©ã‚¦ã‚¶ã‚’æ›´æ–°ã—ã¦ãã ã•ã„</div>';
      }
    }

    // åº§æ¨™ã‚°ãƒªãƒƒãƒ‰ã‚’è¿½åŠ 
    function addCoordinateGrid() {
      // ç·¯åº¦ç·šï¼ˆæ±è¥¿æ–¹å‘ï¼‰
      for (let lat = 35.0; lat <= 36.0; lat += 0.1) {
        viewer.entities.add({
          polyline: {
            positions: Cesium.Cartesian3.fromDegreesArray([139.0, lat, 140.0, lat]),
            width: 1,
            material: Cesium.Color.WHITE.withAlpha(0.3)
          }
        });
      }
      
      // çµŒåº¦ç·šï¼ˆå—åŒ—æ–¹å‘ï¼‰
      for (let lon = 139.0; lon <= 140.0; lon += 0.1) {
        viewer.entities.add({
          polyline: {
            positions: Cesium.Cartesian3.fromDegreesArray([lon, 35.0, lon, 36.0]),
            width: 1,
            material: Cesium.Color.WHITE.withAlpha(0.3)
          }
        });
      }
    }

    function setupEventListeners() {
      // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
      document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file || !viewer) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const geojson = JSON.parse(e.target.result);
            loadGeoJSON(geojson, file.name);
          } catch (error) {
            updateStatus('âŒ ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
          }
        };
        reader.readAsText(file);
      });

      // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
      viewer.cesiumWidget.screenSpaceEventHandler.setInputAction(function(click) {
        const pickedObject = viewer.scene.pick(click.position);
        if (pickedObject && pickedObject.id && pickedObject.id.name) {
          updateStatus(`ğŸ“ ã‚¯ãƒªãƒƒã‚¯: ${pickedObject.id.name}`, 'info');
        }
      }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
    }

    // GeoJSONãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    async function loadDefaultGeoJSON() {
      try {
        const response = await fetch('./data/sample.geojson');
        if (response.ok) {
          const geojson = await response.json();
          loadGeoJSON(geojson, 'sample.geojson');
        }
      } catch (error) {
        console.log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆGeoJSONã®èª­ã¿è¾¼ã¿ã‚’ã‚¹ã‚­ãƒƒãƒ—:', error.message);
        updateStatus('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ', 'info');
      }
    }

    function loadGeoJSON(geojson, filename) {
      if (!viewer) return;
      
      try {
        updateStatus(`GeoJSONãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­: ${filename}`, 'info');
        
        // æ—¢å­˜ã®GeoJSONã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’å‰Šé™¤ï¼ˆã‚°ãƒªãƒƒãƒ‰ã¯ä¿æŒï¼‰
        const entities = viewer.entities.values;
        for (let i = entities.length - 1; i >= 0; i--) {
          const entity = entities[i];
          if (entity.properties && entity.properties.geojson) {
            viewer.entities.remove(entity);
          }
        }
        
        // GeoJSONãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ä½œæˆ
        const dataSource = new Cesium.GeoJsonDataSource();
        dataSource.load(geojson, {
          stroke: Cesium.Color.YELLOW,
          fill: Cesium.Color.YELLOW.withAlpha(0.7),
          strokeWidth: 3,
          markerSymbol: 'ğŸ“',
          markerColor: Cesium.Color.RED,
          markerSize: 48
        }).then(() => {
          viewer.dataSources.add(dataSource);
          
          // ãƒ‡ãƒ¼ã‚¿ã«ãƒãƒ¼ã‚¯ã‚’ä»˜ã‘ã‚‹
          const entities = dataSource.entities.values;
          entities.forEach(entity => {
            entity.properties = { geojson: true };
          });
          
          viewer.zoomTo(dataSource);
          updateStatus(`âœ… GeoJSONãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†: ${filename} (${entities.length}ä»¶)`, 'success');
        }).catch(error => {
          console.error('GeoJSONãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
          updateStatus('âŒ GeoJSONãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—: ' + error.message, 'error');
        });
        
      } catch (error) {
        console.error('GeoJSONèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        updateStatus('âŒ GeoJSONèª­ã¿è¾¼ã¿å¤±æ•—: ' + error.message, 'error');
      }
    }

    // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«é–¢æ•°
    function loadSampleData() {
      loadDefaultGeoJSON();
    }

    function resetView() {
      if (!viewer) return;
      viewer.camera.setView({
        destination: Cesium.Cartesian3.fromDegrees(139.767, 35.681, 50000),
        orientation: {
          heading: 0.0,
          pitch: -Math.PI / 6,
          roll: 0.0
        }
      });
      updateStatus('ğŸ  æ±äº¬ã«æˆ»ã‚Šã¾ã—ãŸ', 'info');
    }

    function toggleWireframe() {
      if (!viewer) return;
      wireframeMode = !wireframeMode;
      viewer.scene.globe.enableLighting = wireframeMode;
      updateStatus(wireframeMode ? 'ğŸ”² ãƒ¯ã‚¤ãƒ¤ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰' : 'ğŸŒ é€šå¸¸ãƒ¢ãƒ¼ãƒ‰', 'info');
    }

    // åˆæœŸåŒ–é–‹å§‹
    document.addEventListener('DOMContentLoaded', initializeCesium);
  </script>
</body>
</html>
