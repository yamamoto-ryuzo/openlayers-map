<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Cesium 3D GeoJSON Viewer (Full Features)</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    body { margin: 0; padding: 10px; font-family: Arial, sans-serif; }
    h1 { margin: 0 0 10px 0; }
    #cesiumContainer { width: 100%; height: 600px; display: block; border: 1px solid #ccc; }
    #fileInput { margin: 10px 0; }
    #status { margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 4px; }
    .note { margin: 10px 0; padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>ğŸŒ Cesium 3D GeoJSON Viewer (Full Features)</h1>
  <div class="note">
    <strong>ğŸ“ æ³¨æ„:</strong> ã“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯å®Œå…¨ãªCesium Ionæ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
    ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèƒŒæ™¯ãŒåˆ©ç”¨å¯èƒ½ã§ã€baseLayerPickerã§èƒŒæ™¯ã‚’é¸æŠã§ãã¾ã™ã€‚
  </div>
  <div id="status">åˆæœŸåŒ–ä¸­...</div>
  <input type="file" id="fileInput" accept=".geojson,.json" />
  <div id="cesiumContainer"></div>
  
  <script>
    const statusDiv = document.getElementById('status');
    let viewer = null;
    
    function updateStatus(message) {
      statusDiv.textContent = message;
      console.log(message);
    }

    // Cesium Ion ã®å®Œå…¨ãªæ©Ÿèƒ½ã‚’ä½¿ç”¨
    async function initializeCesium() {
      updateStatus('Cesiumï¼ˆå®Œå…¨ç‰ˆï¼‰ã‚’åˆæœŸåŒ–ä¸­...');
      
      try {
        // ãƒ•ãƒ«æ©Ÿèƒ½ã®Cesiumãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼
        viewer = new Cesium.Viewer('cesiumContainer', {
          baseLayerPicker: true,  // èƒŒæ™¯é¸æŠæ©Ÿèƒ½ã‚’æœ‰åŠ¹
          vrButton: false,
          geocoder: true,         // åœ°åæ¤œç´¢ã‚’æœ‰åŠ¹
          homeButton: true,
          sceneModePicker: true,  // 2D/3Dåˆ‡ã‚Šæ›¿ãˆã‚’æœ‰åŠ¹
          navigationHelpButton: true,
          animation: false,
          timeline: false,
          fullscreenButton: true,
          infoBox: true,
          selectionIndicator: true
        });

        updateStatus('âœ… Cesiumå®Œå…¨ç‰ˆåˆæœŸåŒ–æˆåŠŸï¼æ±äº¬ã«ç§»å‹•ä¸­...');

        // æ±äº¬ã‚’ä¸­å¿ƒã«è¨­å®š
        viewer.camera.setView({
          destination: Cesium.Cartesian3.fromDegrees(139.767, 35.681, 50000)
        });

        updateStatus('âœ… åˆæœŸåŒ–å®Œäº†ï¼èƒŒæ™¯é¸æŠã‚„ã‚¸ã‚ªã‚³ãƒ¼ãƒ€ãƒ¼ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚');

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        setupEventListeners();
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆGeoJSONã‚’èª­ã¿è¾¼ã¿
        loadDefaultGeoJSON();

      } catch (error) {
        console.error('CesiumåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        updateStatus('âŒ CesiumåˆæœŸåŒ–å¤±æ•—: ' + error.message);
        
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: OpenStreetMapã§åˆæœŸåŒ–
        updateStatus('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: OpenStreetMapã§å†åˆæœŸåŒ–ä¸­...');
        try {
          viewer = new Cesium.Viewer('cesiumContainer', {
            imageryProvider: new Cesium.UrlTemplateImageryProvider({
              url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
              subdomains: ['a', 'b', 'c'],
              maximumLevel: 18,
              credit: 'Map data Â© OpenStreetMap contributors'
            }),
            baseLayerPicker: false,
            vrButton: false,
            geocoder: false,
            homeButton: true,
            sceneModePicker: false,
            navigationHelpButton: false,
            animation: false,
            timeline: false,
            fullscreenButton: true
          });
          
          viewer.camera.setView({
            destination: Cesium.Cartesian3.fromDegrees(139.767, 35.681, 50000)
          });
          
          updateStatus('âœ… OpenStreetMapã§åˆæœŸåŒ–æˆåŠŸï¼');
          setupEventListeners();
          loadDefaultGeoJSON();
          
        } catch (fallbackError) {
          console.error('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', fallbackError);
          updateStatus('âŒ åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
          document.getElementById('cesiumContainer').innerHTML = 
            '<div style="padding: 20px; color: red; text-align: center;">3Dåœ°å›³ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ<br>' + 
            'ãƒ–ãƒ©ã‚¦ã‚¶ã‚’æ›´æ–°ã™ã‚‹ã‹ã€ä»–ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è©¦ã—ã¦ãã ã•ã„</div>';
        }
      }
    }

    function setupEventListeners() {
      // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
      document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            try {
              const geojson = JSON.parse(e.target.result);
              loadGeoJSON(geojson, file.name);
            } catch (error) {
              alert('GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
          };
          reader.readAsText(file);
        }
      });
    }

    async function loadDefaultGeoJSON() {
      try {
        const response = await fetch('./data/sample.geojson');
        if (response.ok) {
          const geojson = await response.json();
          loadGeoJSON(geojson, 'sample.geojson');
        }
      } catch (error) {
        console.log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆGeoJSONã®èª­ã¿è¾¼ã¿ã‚’ã‚¹ã‚­ãƒƒãƒ—:', error.message);
      }
    }

    function loadGeoJSON(geojson, filename) {
      if (!viewer) return;
      
      try {
        updateStatus('GeoJSONãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­: ' + filename);
        
        // æ—¢å­˜ã®GeoJSONã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’å‰Šé™¤
        viewer.entities.removeAll();
        
        // GeoJSONãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ä½œæˆ
        const dataSource = new Cesium.GeoJsonDataSource();
        dataSource.load(geojson, {
          stroke: Cesium.Color.YELLOW,
          fill: Cesium.Color.YELLOW.withAlpha(0.5),
          strokeWidth: 3,
          markerSymbol: '?'
        }).then(() => {
          viewer.dataSources.add(dataSource);
          viewer.zoomTo(dataSource);
          updateStatus('âœ… GeoJSONãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†: ' + filename);
        }).catch(error => {
          console.error('GeoJSONãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
          updateStatus('âŒ GeoJSONãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—: ' + error.message);
        });
        
      } catch (error) {
        console.error('GeoJSONèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        updateStatus('âŒ GeoJSONèª­ã¿è¾¼ã¿å¤±æ•—: ' + error.message);
      }
    }

    // åˆæœŸåŒ–é–‹å§‹
    document.addEventListener('DOMContentLoaded', initializeCesium);
  </script>
</body>
</html>
